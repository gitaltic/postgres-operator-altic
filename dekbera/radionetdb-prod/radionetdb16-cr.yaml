apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  labels:
    argocd.argoproj.io/instance: radionetdb16
  name: radionetdb16
  namespace: radionet
spec:
  shutdown: false # upgrade 
  postgresVersion: 16
  postGISVersion: "3.3"
  backups:
    pgbackrest:
      manual:
        repoName: repo1
        options:
         - --type=full --stop-auto
      configuration:
      - secret:
          name: radionetdb-backup-secret
      global:
        repo1-path: /pgbackrest/radionetdb16/repo1
        repo1-retention-full: "1"
        repo1-retention-full-type: time
        repo1-retention-diff: "6"
      repos:
      - name: repo1
        azure:
          container: dekberaddprodbck
        schedules:
          full: "0 2 * * 6"
          differential: "0 2 * * 0-5"
  instances:
    - dataVolumeClaimSpec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 400Gi
        storageClassName: managed-csi-zrs
      name: radionetdb16
      replicas: 2
      resources:
        requests:
          cpu: 500m
          memory: 4Gi
        limits:
          cpu: 3M
          memory: 12Gi
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - preference:
                matchExpressions:
                  - key: node
                    operator: In
                    values:
                      - dbruntime
              weight: 1
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    postgres-operator.crunchydata.com/cluster: radionetdb16
                    postgres-operator.crunchydata.com/instance-set: radionetdb16
                topologyKey: kubernetes.io/hostname
              weight: 1
      tolerations:
        - effect: NoSchedule
          key: node
          operator: Equal
          value: dbruntime
  service:
    type: LoadBalancer
    metadata:
     annotations:
       service.beta.kubernetes.io/azure-load-balancer-internal: "true"
       service.beta.kubernetes.io/azure-load-balancer-tcp-idle-timeout: "30"
       service.beta.kubernetes.io/port_5432_no_lb_rule: "true"
  users:
    - name: postgres
